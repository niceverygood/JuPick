// src/app/api/user/reports/route.ts

import { NextRequest, NextResponse } from 'next/server'
import { auth } from '@/lib/auth'
import prisma from '@/lib/prisma'
import { canUseFeature, getMarketReportLevel, PLAN_LIMITS, PlanType } from '@/lib/planLimits'

export async function GET(req: NextRequest) {
  try {
    const session = await auth()
    if (!session?.user?.id) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const user = await prisma.user.findUnique({
      where: { id: session.user.id },
      select: { plan: true }
    })

    if (!user) {
      return NextResponse.json({ error: 'User not found' }, { status: 404 })
    }

    const plan = user.plan as PlanType

    // ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬
    if (!canUseFeature(plan, 'marketReport')) {
      return NextResponse.json({ 
        error: 'Feature not available',
        message: 'ì‹œì¥ ë¶„ì„ ë¦¬í¬íŠ¸ëŠ” Basic í”Œëœ ì´ìƒì—ì„œ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.',
        upgradeRequired: true,
        requiredPlan: 'BASIC',
        // ë¯¸ë¦¬ë³´ê¸° ë°ì´í„°
        preview: {
          title: '2026ë…„ 1ì›” ì£¼ê°„ ì‹œì¥ ì „ë§',
          summary: 'ì´ ë¦¬í¬íŠ¸ëŠ” Basic í”Œëœ ì´ìƒì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤...',
        }
      }, { status: 403 })
    }

    const reportLevel = getMarketReportLevel(plan)

    // ë¦¬í¬íŠ¸ ëª©ë¡ ì¡°íšŒ
    let reports = await prisma.marketReport.findMany({
      orderBy: { reportDate: 'desc' },
      take: 10
    })

    // ë¦¬í¬íŠ¸ê°€ ì—†ìœ¼ë©´ ë°ëª¨ ë¦¬í¬íŠ¸ ìƒì„±
    if (reports.length === 0) {
      reports = await generateDemoReports()
    }

    // í”Œëœë³„ ì½˜í…ì¸  í•„í„°ë§
    const filteredReports = reports.map(report => {
      let content = report.summary // ê¸°ë³¸ê°’: ìš”ì•½ë§Œ

      if (reportLevel === 'detailed') {
        content = report.detailed
      } else if (reportLevel === 'premium') {
        content = report.premium
      }

      return {
        id: report.id,
        title: report.title,
        content,
        reportType: report.reportType,
        reportDate: report.reportDate,
        createdAt: report.createdAt,
        // ìƒìœ„ í”Œëœ ì½˜í…ì¸  ë¯¸ë¦¬ë³´ê¸° ì—¬ë¶€
        hasDetailedContent: reportLevel === 'basic',
        hasPremiumContent: reportLevel !== 'premium',
        previewText: reportLevel !== 'premium' 
          ? 'í”„ë¦¬ë¯¸ì—„ êµ¬ë…ìë¥¼ ìœ„í•œ ì‹¬ì¸µ ë¶„ì„ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.' 
          : null
      }
    })

    return NextResponse.json({
      reports: filteredReports,
      reportLevel
    })

  } catch (error) {
    console.error('Reports GET error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}

// ë°ëª¨ ë¦¬í¬íŠ¸ ìƒì„±
async function generateDemoReports() {
  const reportsData = [
    {
      title: '2026ë…„ 1ì›” 2ì£¼ì°¨ ì£¼ê°„ ì‹œì¥ ì „ë§',
      reportType: 'WEEKLY' as const,
      summary: `ğŸ“Š ì£¼ê°„ ì‹œì¥ ìš”ì•½\n\nì½”ìŠ¤í”¼ëŠ” ì´ë²ˆ ì£¼ 2,650ì„ ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë“±ë½ì„ ê±°ë“­í•  ì „ë§ì…ë‹ˆë‹¤. ë¯¸êµ­ CPI ë°œí‘œì™€ êµ­ë‚´ ê¸°ì—…ë“¤ì˜ 4ë¶„ê¸° ì‹¤ì  ë°œí‘œê°€ ì£¼ìš” ë³€ìˆ˜ë¡œ ì‘ìš©í•  ê²ƒì…ë‹ˆë‹¤.\n\nì£¼ìš” ê´€ì‹¬ ì„¹í„°: ë°˜ë„ì²´, 2ì°¨ì „ì§€`,
      detailed: `ğŸ“Š ì£¼ê°„ ì‹œì¥ ìƒì„¸ ë¶„ì„\n\nâ–  ê±°ì‹œê²½ì œ í™˜ê²½\n- ë¯¸êµ­ ê¸ˆë¦¬ ë™ê²° ê¸°ì¡° ìœ ì§€ ì˜ˆìƒ\n- ë‹¬ëŸ¬/ì› í™˜ìœ¨ 1,300ì›ëŒ€ ì•ˆì •ì„¸\n- êµ­ë‚´ ìˆ˜ì¶œ ì „ë…„ ëŒ€ë¹„ 10% ì¦ê°€ ì˜ˆìƒ\n\nâ–  ì„¹í„°ë³„ ë¶„ì„\n\n[ë°˜ë„ì²´]\n- AI ì„œë²„ìš© HBM ìˆ˜ìš” ì§€ì† ì¦ê°€\n- ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤ ì‹¤ì  ê°œì„  ê¸°ëŒ€\n- íˆ¬ìì˜ê²¬: ë¹„ì¤‘í™•ëŒ€\n\n[2ì°¨ì „ì§€]\n- ì „ê¸°ì°¨ íŒë§¤ ë‘”í™”ì—ë„ ë¶ˆêµ¬, ì—ë„ˆì§€ì €ì¥ì¥ì¹˜(ESS) ìˆ˜ìš” ê¸‰ì¦\n- ì–‘ê·¹ì¬ ì—…ì²´ ìˆ˜ìµì„± ê°œì„  ì „ë§\n- íˆ¬ìì˜ê²¬: ì¤‘ë¦½\n\nâ–  ì£¼ê°„ ì¶”ì²œ ì „ëµ\n1. ë°˜ë„ì²´ ëŒ€í˜•ì£¼ ì¤‘ì‹¬ í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±\n2. ë³€ë™ì„± í™•ëŒ€ ì‹œ ì €ê°€ ë§¤ìˆ˜ ê¸°íšŒ í™œìš©\n3. ì‹¤ì  ë°œí‘œ ì „ ë‹¨ê¸° íŠ¸ë ˆì´ë”© ê¸°íšŒ í¬ì°©`,
      premium: `ğŸ“Š í”„ë¦¬ë¯¸ì—„ ì£¼ê°„ ì‹œì¥ ë¶„ì„ ë¦¬í¬íŠ¸\n\nâ–  ê±°ì‹œê²½ì œ ì‹¬ì¸µ ë¶„ì„\n\n1. ê¸€ë¡œë²Œ ìœ ë™ì„± ì „ë§\në¯¸ ì—°ì¤€ì˜ ê¸ˆë¦¬ ì •ì±… ê¸°ì¡° ë³€í™”ì— ë”°ë¥¸ ê¸€ë¡œë²Œ ìœ ë™ì„± í™˜ê²½ ë¶„ì„. 3ì›” FOMC ê¸ˆë¦¬ ì¸í•˜ ê°€ëŠ¥ì„± 40%ë¡œ ìƒí–¥. ì´ì— ë”°ë¥¸ ì‹ í¥êµ­ ìê¸ˆ ìœ ì… ê¸°ëŒ€.\n\n2. êµ­ë‚´ ê²½ì œ ì§€í‘œ ë¶„ì„\n- GDP ì„±ì¥ë¥ : 2.3% ì „ë§ (ìƒí–¥ ì¡°ì •)\n- ìˆ˜ì¶œ ì¦ê°€ìœ¨: 12% (ë°˜ë„ì²´ ê¸°ì—¬ 60%)\n- ì†Œë¹„ìë¬¼ê°€: 2.5% (ì•ˆì •ì„¸)\n\nâ–  AI ê¸°ë°˜ ì •ëŸ‰ ë¶„ì„\n\n[ê¸°ìˆ ì  ë¶„ì„]\n- ì½”ìŠ¤í”¼ RSI: 58 (ì¤‘ë¦½ êµ¬ê°„)\n- MACD: ê³¨ë“ í¬ë¡œìŠ¤ ì„ë°•\n- ì™¸êµ­ì¸ ìˆ˜ê¸‰: 5ê±°ë˜ì¼ ì—°ì† ìˆœë§¤ìˆ˜\n\n[AI ì˜ˆì¸¡ ëª¨ë¸ ê²°ê³¼]\n- ì½”ìŠ¤í”¼ ì£¼ê°„ ì˜ˆìƒ ë²”ìœ„: 2,620 ~ 2,680\n- ìµœì  ë§¤ìˆ˜ ì‹œì : ì›”ìš”ì¼ ì˜¤ì „ ì¥ì¤‘\n- ì£¼ê°„ ìƒìŠ¹ í™•ë¥ : 65%\n\nâ–  ì„¹í„°ë³„ ì‹¬ì¸µ ë¶„ì„\n\n[ë°˜ë„ì²´ - ìµœìš°ì„  ê´€ì‹¬]\níˆ¬ì í¬ì¸íŠ¸:\n1. HBM3E ì–‘ì‚° ì‹œì‘ìœ¼ë¡œ ë§ˆì§„ìœ¨ ê°œì„ \n2. ì‚¼ì„±ì „ì GAA ê³µì • ìˆ˜ìœ¨ ê°œì„  ì†Œì‹\n3. ì¤‘êµ­ ë°˜ë„ì²´ ê·œì œ ì™„í™” ê¸°ëŒ€ê°\n\nì¶”ì²œ ì¢…ëª©:\n- ì‚¼ì„±ì „ì (005930): ëª©í‘œê°€ 95,000ì› (+31%)\n- SKí•˜ì´ë‹‰ìŠ¤ (000660): ëª©í‘œê°€ 200,000ì› (+40%)\n- í•œë¯¸ë°˜ë„ì²´ (042700): ëª©í‘œê°€ 85,000ì› (+25%)\n\n[2ì°¨ì „ì§€ - ì„ ë³„ì  ì ‘ê·¼]\níˆ¬ì í¬ì¸íŠ¸:\n1. ESS ìˆ˜ìš” í­ë°œì  ì¦ê°€\n2. ë‚˜íŠ¸ë¥¨ì´ì˜¨ì „ì§€ ìƒìš©í™” ê¸°ëŒ€\n3. ë¯¸êµ­ IRA ì„¸ë¶€ ê°€ì´ë“œë¼ì¸ ê¸ì •ì \n\nì¶”ì²œ ì¢…ëª©:\n- ì—ì½”í”„ë¡œë¹„ì—  (247540): ëª©í‘œê°€ 240,000ì› (+23%)\n- ì‚¼ì„±SDI (006400): ëª©í‘œê°€ 500,000ì› (+21%)\n\nâ–  ì£¼ê°„ í¬íŠ¸í´ë¦¬ì˜¤ ì „ëµ\n\n[ì ê·¹ íˆ¬ìí˜•]\n- ë°˜ë„ì²´ 50% / 2ì°¨ì „ì§€ 30% / í˜„ê¸ˆ 20%\n- ì˜ˆìƒ ìˆ˜ìµë¥ : +5~8%\n- ìœ„í—˜ë„: ì¤‘ìƒ\n\n[ì•ˆì • íˆ¬ìí˜•]\n- ë°˜ë„ì²´ 30% / ë°°ë‹¹ì£¼ 40% / í˜„ê¸ˆ 30%\n- ì˜ˆìƒ ìˆ˜ìµë¥ : +2~4%\n- ìœ„í—˜ë„: ì¤‘í•˜\n\nâ–  ë¦¬ìŠ¤í¬ ìš”ì¸\n1. ë¯¸êµ­ ê³ ìš©ì§€í‘œ ì˜ˆìƒ ìƒíšŒ ì‹œ ê¸ˆë¦¬ ì¸ìƒ ìš°ë ¤ ì¬ë¶€ê°\n2. ì¤‘ë™ ì§€ì •í•™ì  ë¦¬ìŠ¤í¬\n3. ì¤‘êµ­ ê²½ê¸° ë‘”í™” ê°€ì†í™” ê°€ëŠ¥ì„±\n\nâ–  ê²°ë¡ \nì´ë²ˆ ì£¼ëŠ” ì‹¤ì  ì‹œì¦Œ ì§„ì…ê³¼ í•¨ê»˜ ê°œë³„ ì¢…ëª© ì¥ì„¸ê°€ ì˜ˆìƒë©ë‹ˆë‹¤. ë°˜ë„ì²´ ëŒ€í˜•ì£¼ ì¤‘ì‹¬ì˜ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ìœ ì§€í•˜ë˜, ë³€ë™ì„± í™•ëŒ€ êµ¬ê°„ì—ì„œ ì €ê°€ ë§¤ìˆ˜ ê¸°íšŒë¥¼ ì ê·¹ í™œìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.`,
    },
    {
      title: '2026ë…„ 1ì›” ì›”ê°„ ì‹œì¥ ì „ë§',
      reportType: 'MONTHLY' as const,
      summary: `ğŸ“ˆ ì›”ê°„ ì‹œì¥ ìš”ì•½\n\n2026ë…„ 1ì›”ì€ ì‹¤ì  ì‹œì¦Œê³¼ í•¨ê»˜ ìƒˆí•´ ê¸°ëŒ€ê°ì´ ë°˜ì˜ë˜ëŠ” ì‹œê¸°ì…ë‹ˆë‹¤. AI ë°˜ë„ì²´ ìˆ˜ìš” ì¦ê°€ì™€ ê¸ˆë¦¬ ì¸í•˜ ê¸°ëŒ€ê°ì´ ì‹œì¥ì„ ê²¬ì¸í•  ì „ë§ì…ë‹ˆë‹¤.`,
      detailed: `ğŸ“ˆ ì›”ê°„ ì‹œì¥ ìƒì„¸ ë¶„ì„\n\nâ–  1ì›” ì£¼ìš” ì¼ì •\n- 1/10: ë¯¸êµ­ ê³ ìš©ë³´ê³ ì„œ\n- 1/15: ì¤‘êµ­ GDP ë°œí‘œ\n- 1/20: êµ­ë‚´ ì£¼ìš” ê¸°ì—… ì‹¤ì  ë°œí‘œ ì‹œì‘\n\nâ–  ì›”ê°„ íˆ¬ì ì „ëµ\n1. ì‹¤ì  ì‹œì¦Œ ëŒ€ë¹„ í¬íŠ¸í´ë¦¬ì˜¤ ì ê²€\n2. AI ë°˜ë„ì²´ ê´€ë ¨ì£¼ ë¹„ì¤‘ í™•ëŒ€\n3. ë°°ë‹¹ì£¼ ì¤‘ì‹¬ ì•ˆì •ì  í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±`,
      premium: `ğŸ“ˆ í”„ë¦¬ë¯¸ì—„ ì›”ê°„ ì‹œì¥ ë¶„ì„ ë¦¬í¬íŠ¸\n\n(ìƒì„¸ í”„ë¦¬ë¯¸ì—„ ë¶„ì„ ë‚´ìš©...)\n\n[AI ì˜ˆì¸¡]\n- ì›”ê°„ ì½”ìŠ¤í”¼ ì˜ˆìƒ ë²”ìœ„: 2,550 ~ 2,750\n- ìµœì  ì„¹í„°: ë°˜ë„ì²´ > ìë™ì°¨ > ë°”ì´ì˜¤\n- ë¦¬ìŠ¤í¬ ë ˆë²¨: ì¤‘ê°„`,
    },
    {
      title: 'ì˜¤ëŠ˜ì˜ ì‹œì¥ ë¸Œë¦¬í•‘',
      reportType: 'DAILY' as const,
      summary: `ğŸ“° ì˜¤ëŠ˜ì˜ ì‹œì¥\n\nì½”ìŠ¤í”¼ +0.8% ìƒìŠ¹ ë§ˆê°. ì™¸êµ­ì¸ 2,500ì–µ ìˆœë§¤ìˆ˜. ë°˜ë„ì²´ ê°•ì„¸ ì§€ì†.`,
      detailed: `ğŸ“° ì˜¤ëŠ˜ì˜ ì‹œì¥ ìƒì„¸\n\nâ–  ì§€ìˆ˜ ë™í–¥\n- ì½”ìŠ¤í”¼: 2,655.32 (+0.82%)\n- ì½”ìŠ¤ë‹¥: 875.45 (+1.23%)\n\nâ–  ìˆ˜ê¸‰ ë™í–¥\n- ì™¸êµ­ì¸: +2,500ì–µ (3ì¼ ì—°ì† ìˆœë§¤ìˆ˜)\n- ê¸°ê´€: -1,200ì–µ\n- ê°œì¸: -1,300ì–µ\n\nâ–  íŠ¹ì§•ì£¼\n- ì‚¼ì„±ì „ì: +2.1% (ì™¸êµ­ì¸ ì§‘ì¤‘ ë§¤ìˆ˜)\n- SKí•˜ì´ë‹‰ìŠ¤: +3.5% (HBM ê¸°ëŒ€ê°)`,
      premium: `ğŸ“° í”„ë¦¬ë¯¸ì—„ ì¼ì¼ ë¶„ì„\n\n(ìƒì„¸ í”„ë¦¬ë¯¸ì—„ ë¶„ì„ ë‚´ìš©...)\n\n[AI ë‹¨ê¸° ì „ë§]\n- ë‚´ì¼ ì˜ˆìƒ: ì†Œí­ ìƒìŠ¹\n- ì£¼ê°„ ì˜ˆìƒ: ë°•ìŠ¤ê¶Œ\n- ì¶”ì²œ ì „ëµ: ë°˜ë„ì²´ ë¹„ì¤‘ ìœ ì§€`,
    },
  ]

  const reports = await Promise.all(
    reportsData.map((data, index) =>
      prisma.marketReport.create({
        data: {
          ...data,
          content: data.summary,
          reportDate: new Date(Date.now() - index * 24 * 60 * 60 * 1000)
        }
      })
    )
  )

  return reports
}


